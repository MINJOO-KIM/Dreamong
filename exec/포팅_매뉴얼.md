# 포팅 매뉴얼

# 사용 프로그램 버전

---

<aside>
💡 **프로젝트에서 사용한 프로그램의 버전을 정리합니다.**

</aside>

## Backend

- Development Tool
    - JDK : 17.0.11
    - gradle : 8.8
- Framework
    - Spring boot : 3.3.2
        - Spring data JPA
        - Validation
    - Spring Doc: 2.0.2
    - OpenAI: 1.0.0-M1
    - Spring Cloud AWS: 2.2.6.RELEASE
- Security
    - JWT 0.12.3
    - Spring Security
    - OAuth2 Client
- Database
    - MySQL: 8.0.36
    - Spring Data Redis: 3.3.2
- Networking and Sockets
    - Netty-SocketIO: 2.0.11
- Utilities
    - Lombok: 1.18.34
    - OkHttp: 4.9.3
- Infra
    - Ununtu: 20.04.6 LTS
    - Docker: 27.1.1
    - Docker Compose : 2.29.1
    - Nginx: 1.27.0
    - certbot: 0.40.0
    - MySQL: 9.0.1

---

## Frontend

---

- **axios**: 1.7.2
- **flowbite-react**: 0.10.1
- **ldrs**: 1.0.2
- **react**: 18.3.1
- **react-dom**: 18.3.1
- **react-infinite-scroll-component**: 6.1.0
- **react-modal**: 3.16.1
- **react-router-dom**: 6.25.1
- **react-speech-recognition**: 3.10.0
- **react-youtube**: 10.1.0
- **recoil**: 0.7.7
- **regenerator-runtime**: 0.14.1
- **socket.io-client**: 4.7.5
- **sweetalert2**: 11.6.13
- **swiper**: 11.1.9

# 배포환경

---

<aside>
💡 **서버구성에 사용된 코드를 정리합니다**

</aside>

Front

1. nvm 설치
    
    ```bash
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
    source ~/.bashrc
    ```
    
2. Node.js 20.15 버전 설치 및 사용
    
    ```bash
    nvm install 20.15.0
    nvm use 20.15.0
    
    npm install -g npm@latest
    ```
    
3. 프로젝트 디렉토리로 이동하여 의존성 설치 및 빌드
    
    ```bash
    cd ~/project/S11P12C106/frontend/dreamong
    npm install
    npm run build
    ```
    

Docker Compose

```bash
sudo apt install docker-compose
```

ec2 정보 조회 : `cat /etc/**release**`

## 서비스 포트 문서화

### SSH

- **포트 번호:** 22
- **역할:** 원격 서버 관리 및 접근

### MySQL (mysql-container)

- **포트 번호:** 3306
- **역할:** MySQL Database Server

### Redis (redis-container)

- **포트 번호:** 6379
- **역할:** Redis Database Server

### Backend (backend-container)

- **포트 번호:** 8080
- **역할:** Spring Boot Server
- **포트 번호:** 9093
- **역할: N**etty Socket Server

### Frontend (frontend-container)

- **포트 번호:** 5173
- **역할:**  React Front Application

### Nginx (nginx-container)

- **포트 번호:** 80, 443
- **역할:** HTTP, HTTPS Web Server (Reverse Proxy)

## /etc/nginx/nginx.conf

```bash
user www-data;
worker_processes auto;
pid /run/nginx.pid;
#include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # Virtual Host Configs
        ##
        include /etc/nginx/sites-available/*;
        include /etc/nginx/conf.d/*.conf;
        #include /etc/nginx/sites-enabled/*;
}

#mail {
#       # See sample authentication script at:
#       # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#       # auth_http localhost/auth.php;
#       # pop3_capabilities "TOP" "USER";
#       # imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#       server {
#               listen     localhost:110;
#               protocol   pop3;
#               proxy      on;
#       }
#
#       server {  
#               protocol   imap;
#               proxy      on;
#       }
#}
           
```

## /etc/nginx/sites-available/default

```bash
resolver 127.0.0.11 valid=30s;

# HTTP 요청을 HTTPS로 리디렉션하는 서버 블록
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name i11c106.p.ssafy.io;

    # 모든 HTTP 요청을 HTTPS로 리디렉션
    return 301 https://$host$request_uri;
}

# SSL을 사용한 HTTPS 서버 블록
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name i11c106.p.ssafy.io;

    # SSL 인증서 경로 및 키
    ssl_certificate /etc/letsencrypt/live/i11c106.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/i11c106.p.ssafy.io/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location = /firebase-messaging-sw.js {
        root /app/dist;  # 빌드된 정적 파일이 위치한 경로
        default_type application/javascript;
        types { }
        add_header Service-Worker-Allowed "/";
        add_header Cache-Control "no-cache";
#       try_files $uri =404;
    }

    # 백엔드 애플리케이션 프록시 설정
    location /api {
        proxy_pass http://backend-container:8080;
#        proxy_pass http://172.18.0.4:8080;  # 백엔드 애플리케이션이 실행 중인 포트
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;
    }

    # 프론트엔드 애플리케이션 프록시 설정
    location / {
        proxy_pass http://frontend-container:5173;
#        proxy_pass http://172.18.0.3:5173;  # 프론트엔드 애플리케이션이 실행 중인 포트
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
#       try_files $uri $uri/ /index.html;  # 프론트엔드 SPA 지원

        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;

    }

    # WebSocket 프록시 설정
    location /socket.io/ {
        proxy_pass http://172.18.0.4:9093;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket에 대한 버퍼 설정
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # WebSocket 연결 시 timeout 설정
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 60s;

        # WebSocket 특화 설정 추가
        proxy_buffering off;  # WebSocket 연결시 버퍼 종료
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Ssl on;
     }

    # 추가 보안 헤더
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
           
```

## YML 설정파일

- application.yml

```bash
spring:
  application:
    name: dreamong

  sql:
    init:
      mode: always
      continue-on-error: true

  jpa:
    hibernate:
      ddl-auto: none
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    properties:
      hibernate:
        format_sql: true
      default_batch_fetch_size: 100
      open-in-view: false

  jwt:
    secret: 
    access-token-expiration: 3600000 # 1시간(ms)
    refresh-token-expiration: 604800000  # 7일(ms)
  ai:
    openai:
      api-key: 
      chat:
        options:
          model: gpt-4o-mini

cloud:
  aws:
    s3:
      bucket: dreamongbucket
    credentials:
      access-key: 
      secret-key: 
    region:
      static: ap-northeast-2
      auto: false
    stack:
      auto: false

novita:
  api:
    key: 

clova:
  api:
    url: https://clovagreeneye.apigw.ntruss.com/custom/v1/128/c9eee8f785a02fef9693128952bf62e292001c1cc5404e04667bc0c93e5e2fc6/predict
    secret: 

deepl:
  api:
    url: "https://api-free.deepl.com/v2/translate"
    key: 

logging.level:
  org.hibernate.SQL: debug
  org.springframework.web: debug
```

- application-local.yml

```bash
socketio:
  server:
    hostname: localhost
    port: 9093

login:
  callback-url: http://localhost:5173/callback

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/dreamong?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
    username: 
    password: 
    driver-class-name: com.mysql.cj.jdbc.Driver

  data:
    redis:
      host: localhost
      port: 6379
      repositories:
        enabled: false

  security:
    oauth2:
      client:
        registration:
          naver:
            scope: name,email
            client-name: naver
            client-id: 
            redirect-uri: http://localhost:8080/login/oauth2/code/naver
            authorization-grant-type: authorization_code
            client-secret: 
          google:
            authorization-grant-type: authorization_code
            redirect-uri: http://localhost:8080/login/oauth2/code/google
            client-name: google
            client-id: 
            client-secret: 
            scope: profile,email
          kakao:
            redirect-uri: http://localhost:8080/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-id: 
            #client-secret: 
            scope: profile_nickname,account_email
            client-name: kakao

        provider:
          kakao:
            user-name-attribute: id
            user-info-uri: https://kapi.kakao.com/v2/user/me
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
            token-uri: https://nid.naver.com/oauth2.0/token

```

- application-prod.yml

```bash
server:
  servlet:
    context-path: /api

socketio:
  server:
    hostname: 0.0.0.0
    port: 9093

login:
  callback-url: https://i11c106.p.ssafy.io/callback

spring:
  datasource:
    url: jdbc:mysql://mysql-container:3306/dreamong?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
    username: 
    password: 
    driver-class-name: com.mysql.cj.jdbc.Driver

  data:
    redis:
      host: redis-container
      port: 6379
      repositories:
        enabled: false

  security:
    oauth2:
      client:
        registration:
          naver:
            scope: name,email
            client-name: naver
            client-id: xH48M2F3uLnkCwZoejKy
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/naver
            authorization-grant-type: authorization_code
            client-secret: 
          google:
            authorization-grant-type: authorization_code
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/google
            client-name: google
            client-id: 
            client-secret: 
            scope: profile,email
          kakao:
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-id: 
            #client-secret: 
            scope: profile_nickname,account_email
            client-name: kakao

        provider:
          kakao:
            user-name-attribute: id
            user-info-uri: https://kapi.kakao.com/v2/user/me
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
            token-uri: https://nid.naver.com/oauth2.0/token

```

- .env

```bash
MYSQL_ROOT_PASSWORD=
MYSQL_DATABASE=
MYSQL_USER=
MYSQL_PASSWORD=
```

- Dokcerfile - BE

```bash
# 베이스 이미지 선택
FROM openjdk:17-jdk-slim

# 작업 디렉토리 설정
WORKDIR /app

# 소스코드 복사
COPY . .

# 빌드 실행
RUN ./gradlew clean build

# 빌드된 JAR 파일 복사
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar

# 환경 변수 설정
ENV SPRING_PROFILES_ACTIVE=prod

# 애플리케이션 실행
ENTRYPOINT ["java", "-jar", "app.jar"]
```

- Dockerfile - FE

```bash
## Node.js 20.15 이미지 사용
#FROM node:20.15-alpine AS build
#
## 작업 디렉토리 설정
#WORKDIR /app
#
## package.json과 package-lock.json을 복사하고 npm 설치
#COPY package*.json ./
#RUN npm install
#
## 나머지 애플리케이션 소스 복사
#COPY . .
#
## 애플리케이션 빌드
#RUN npm run build
#
## Nginx를 사용하여 정적 파일 제공
#FROM nginx:alpine
#
## 빌드된 파일을 Nginx 디렉토리로 복사
#COPY --from=build /app/dist /usr/share/nginx/html
#
## Nginx 설정 파일 복사
#COPY nginx.conf /etc/nginx/conf.d/default.conf
#
## Nginx 실행
#CMD ["nginx", "-g", "daemon off;"]

# 1단계: React 앱 빌드
FROM node:20.15-alpine AS build

# 작업 디렉토리 설정
WORKDIR /app

# package.json 및 package-lock.json 파일 복사
COPY package*.json ./

# 종속성 설치
RUN npm install

# 애플리케이션 코드 복사
COPY . .

# React 앱 빌드
RUN npm run build

# dist 디렉토리의 내용 확인
RUN ls -la /app/dist

# Stage 2: Node.js 서버로 React 앱 제공
FROM node:20.15-alpine

# 작업 디렉토리 설정
WORKDIR /app

# serve 패키지 전역 설치
RUN npm install -g serve

# 이전 단계에서 빌드된 출력물 복사
COPY --from=build /app/dist /app/dist

# 포트 5173 노출
EXPOSE 5173

# 서버 시작
CMD ["serve", "-s", "dist", "-l", "5173"]
```

docer-compose.yml

```bash
services:
  mysql:
    image: mysql:latest
    container_name: mysql-container
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - dreamong-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:latest
    container_name: redis-container
    ports:
      - "6379:6379"
    networks:
      - dreamong-network
    volumes:
      - redis-data:/data
    restart: always

  backend:
    build:
      context: ./backend/dreamong
    container_name: backend-container
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-container:3306/${MYSQL_DATABASE}?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      - mysql
      - redis
    ports:
      - "8080:8080"
      - "9093:9093"
    networks:
      - dreamong-network
    restart: on-failure

  frontend:
    build:
      context: ./frontend/dreamong
    container_name: frontend-container
    volumes:
      - frontend-dist:/app/dist  # dist 디렉토리를 공유
    ports:
      - "5173:80"
    networks:
      - dreamong-network

  nginx:
    image: nginx:latest
    container_name: nginx-container
    depends_on:
      - backend
      - frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /etc/nginx/sites-available:/etc/nginx/sites-available
      - /etc/nginx/sites-enabled:/etc/nginx/sites-enabled
      - /etc/letsencrypt:/etc/letsencrypt
      - frontend-dist:/app/dist  # Nginx에 dist 디렉토리를 마운트
    networks:
      - dreamong-network
    restart: always

volumes:
  mysql-data:
  redis-data:
  frontend-dist:  # 프론트엔드 빌드 파일을 저장할 볼륨

networks:
  dreamong-network:
```

## 서버환경 설정

### 서버 방화벽 설정

```bash
# ufw 설치명령
sudo apt-get install ufw

# ufw 상태확인 명령
sudo ufw status verbose
sudo ufw status

sudo ufw allow 22 # ssh (이거하고 활성화해야함!)
sudo ufw enable 

# ...
sudo ufw status
```